---
name: Build

on:
  workflow_dispatch:

env:
  AWS_ACCESS_KEY_ID: ${{secrets.DIGITALOCEAN_SPACES_ACCESS_TOKEN}}
  AWS_SECRET_ACCESS_KEY: ${{secrets.DIGITALOCEAN_SPACES_SECRET_KEY}}
  REGION: ${{secrets.DIGITALOCEAN_REGION}}
  MOUNT_POINT: "/opt/hauler"
  BUCKET: "rkub2-github-action-${{ github.run_id }}"

jobs:
  bucket:
    name: Bucket
    runs-on: ubuntu-latest

    steps:
      - name: Set up S3cmd cli tool
        uses: s3-actions/s3cmd@main
        with:
          provider: digitalocean
          region: ${{secrets.DIGITALOCEAN_REGION}}
          access_key: ${{secrets.DIGITALOCEAN_SPACES_ACCESS_TOKEN}}
          secret_key: ${{secrets.DIGITALOCEAN_SPACES_SECRET_KEY}}

      - name: Create Space Bucket
        run: |
          sed -i -e 's/signature_v2.*$/signature_v2 = True/' ~/.s3cfg
          s3cmd mb s3://${BUCKET}
          sleep 10

  package:
    name: Package
    runs-on: ubuntu-latest
    needs: Bucket

    steps:
      - name: Checkout files
        uses: actions/checkout@v4

      - name: Install s3fs-fuse on Ubuntu
        run: |
          sudo apt-get install automake autotools-dev fuse g++ git libcurl4-gnutls-dev libfuse-dev libssl-dev libxml2-dev make pkg-config
          git clone https://github.com/s3fs-fuse/s3fs-fuse.git
          cd s3fs-fuse
          ./autogen.sh
          ./configure
          make
          sudo make install

      - name: Mount Space Bucket
        run: |
          echo "${{secrets.DIGITALOCEAN_SPACES_ACCESS_TOKEN}}:${{secrets.DIGITALOCEAN_SPACES_SECRET_KEY}}" > ./passwd-s3fs
          chmod 600 ./passwd-s3fs
          mkdir -p ${MOUNT_POINT}
          s3fs ${BUCKET} ${MOUNT_POINT} -o url=https://${REGION}.digitaloceanspaces.com -o passwd_file=./passwd-s3fs
          df -Th ${MOUNT_POINT}

      - name: Test Mount point
        run: |
          ls -ld ${MOUNT_POINT}
          cd ${MOUNT_POINT} && touch test
          ls -l ${MOUNT_POINT}

      - name: Install prerequisites
        run: |
          curl -sfL https://get.hauler.dev | bash

      - name: Build
        run: |
          df -Th ${MOUNT_POINT}
          cd ${MOUNT_POINT}
          curl -s https://raw.githubusercontent.com/MozeBaltyk/rkub2/main/hauler_all_the_things.sh -O
          chmod +x hauler_all_the_things.sh
          ${MOUNT_POINT}/hauler_all_the_things.sh build

  cleanup:
    name: Cleanup
    runs-on: ubuntu-latest
    needs: Package
    if: always()

    steps:
      - name: Checkout files
        uses: actions/checkout@v4

      - name: Set up S3cmd cli tool
        uses: s3-actions/s3cmd@main
        with:
          provider: digitalocean
          region: ${{secrets.DIGITALOCEAN_REGION}}
          access_key: ${{secrets.DIGITALOCEAN_SPACES_ACCESS_TOKEN}}
          secret_key: ${{secrets.DIGITALOCEAN_SPACES_SECRET_KEY}}

      - name: Remove Space bucket
        run: |
          sed -i -e 's/signature_v2.*$/signature_v2 = True/' ~/.s3cfg
          s3cmd rb s3://${BUCKET} --recursive
          sleep 10
